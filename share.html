<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TabCal - 공유 일정</title>
  <style>
    :root {
      --bg: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; --text-sub: #94a3b8;
      --border: rgba(71,85,105,0.6); --accent: #3b82f6;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; padding: 0;
    }
    .header {
      padding: 20px 16px 12px; text-align: center;
      border-bottom: 1px solid var(--border);
    }
    .header h1 { font-size: 20px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .header .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
    .header .badge {
      display: inline-block; font-size: 11px; background: var(--accent); color: #fff;
      padding: 2px 8px; border-radius: 10px; margin-top: 6px;
    }
    .nav {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid var(--border);
    }
    .nav button {
      background: none; border: none; color: var(--text-sub); font-size: 20px; cursor: pointer;
      padding: 4px 12px; border-radius: 8px;
    }
    .nav button:active { background: rgba(255,255,255,0.05); }
    .nav .month-title { font-size: 17px; font-weight: 600; }
    .cal-grid {
      display: grid; grid-template-columns: repeat(7, 1fr);
      gap: 1px; padding: 8px;
    }
    .cal-grid .day-header {
      text-align: center; font-size: 11px; font-weight: 600;
      color: var(--text-sub); padding: 6px 0;
    }
    .cal-grid .day-header:first-child { color: #ef4444; }
    .cal-grid .day-header:last-child { color: #3b82f6; }
    .day-cell {
      min-height: 64px; padding: 4px; border-radius: 8px;
      background: var(--card-bg); position: relative; overflow: hidden;
    }
    .day-cell.other-month { opacity: 0.3; }
    .day-cell .day-num {
      font-size: 12px; font-weight: 500; margin-bottom: 2px; text-align: center;
    }
    .day-cell.today .day-num {
      background: var(--accent); color: #fff; border-radius: 50%;
      width: 24px; height: 24px; line-height: 24px; margin: 0 auto 2px;
    }
    .day-cell.sunday .day-num { color: #ef4444; }
    .day-cell.saturday .day-num { color: #3b82f6; }
    .event-chip {
      font-size: 10px; padding: 1px 4px; border-radius: 4px; margin-bottom: 1px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      color: #fff;
    }
    .event-list-section { padding: 16px; }
    .event-list-section h2 {
      font-size: 15px; font-weight: 600; margin-bottom: 12px;
      color: var(--text-sub); border-bottom: 1px solid var(--border); padding-bottom: 8px;
    }
    .event-item {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 10px 12px; border-radius: 10px; background: var(--card-bg);
      margin-bottom: 6px; border: 1px solid var(--border);
    }
    .event-item .ev-dot {
      width: 10px; height: 10px; border-radius: 50%; margin-top: 4px; flex-shrink: 0;
    }
    .event-item .ev-info { flex: 1; }
    .event-item .ev-title { font-size: 14px; font-weight: 500; }
    .event-item .ev-time { font-size: 12px; color: var(--text-sub); margin-top: 2px; }
    .event-item .ev-memo { font-size: 12px; color: var(--text-sub); margin-top: 4px; white-space: pre-wrap; }
    .event-item.completed .ev-title { text-decoration: line-through; color: var(--text-sub); }
    .loading {
      display: flex; align-items: center; justify-content: center;
      min-height: 60vh; font-size: 15px; color: var(--text-sub);
    }
    .error-box {
      text-align: center; padding: 60px 24px; color: var(--text-sub);
    }
    .error-box h2 { font-size: 20px; color: var(--text); margin-bottom: 8px; }
    .footer {
      text-align: center; padding: 24px 16px; font-size: 12px; color: var(--text-sub);
      border-top: 1px solid var(--border); margin-top: 20px;
    }
    .footer a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>

<div id="loadingView" class="loading">일정을 불러오는 중...</div>
<div id="errorView" class="error-box" style="display:none;">
  <h2>일정을 찾을 수 없습니다</h2>
  <p>공유 링크가 만료되었거나 잘못된 링크입니다.</p>
</div>
<div id="mainView" style="display:none;">
  <div class="header">
    <h1><span class="dot" id="projectDot"></span><span id="projectName"></span></h1>
    <div class="badge">읽기 전용</div>
  </div>
  <div class="nav">
    <button id="prevMonth">&lt;</button>
    <span class="month-title" id="monthTitle"></span>
    <button id="nextMonth">&gt;</button>
  </div>
  <div class="cal-grid" id="calGrid"></div>
  <div class="event-list-section" id="eventListSection" style="display:none;">
    <h2 id="eventListTitle"></h2>
    <div id="eventList"></div>
  </div>
  <div class="footer">
    <a href="https://moonsinsa.github.io/tabcal-privacy/">TabCal</a>에서 공유된 일정입니다.
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDLXaQrhninQdUL3TY8pYhCASws-bdRFOs",
    authDomain: "tapcal-241db.firebaseapp.com",
    projectId: "tapcal-241db",
    storageBucket: "tapcal-241db.firebasestorage.app",
    messagingSenderId: "292390897740",
    appId: "1:292390897740:web:77ffe3372038df9df6cce9",
    measurementId: "G-CE6JZ7Y27T"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);
  const shareId = params.get('id');

  let sharedData = null;
  let viewYear, viewMonth;

  async function loadSharedProject() {
    if (!shareId) { showError(); return; }
    try {
      const snap = await getDoc(doc(db, "shared_projects", shareId));
      if (!snap.exists()) { showError(); return; }
      sharedData = snap.data();
      const now = new Date();
      viewYear = now.getFullYear();
      viewMonth = now.getMonth() + 1;
      showMain();
    } catch (e) {
      console.error(e);
      showError();
    }
  }

  function showError() {
    document.getElementById('loadingView').style.display = 'none';
    document.getElementById('errorView').style.display = 'block';
  }

  function showMain() {
    document.getElementById('loadingView').style.display = 'none';
    document.getElementById('mainView').style.display = 'block';
    document.getElementById('projectDot').style.background = sharedData.projectColor || '#6b7280';
    document.getElementById('projectName').textContent = sharedData.projectName || 'Project';
    document.getElementById('prevMonth').onclick = () => { viewMonth--; if (viewMonth < 1) { viewMonth = 12; viewYear--; } render(); };
    document.getElementById('nextMonth').onclick = () => { viewMonth++; if (viewMonth > 12) { viewMonth = 1; viewYear++; } render(); };
    render();
  }

  function pad2(n) { return n.toString().padStart(2, '0'); }

  function render() {
    document.getElementById('monthTitle').textContent = `${viewYear}. ${pad2(viewMonth)}`;
    renderCalendar();
  }

  function renderCalendar() {
    const grid = document.getElementById('calGrid');
    grid.innerHTML = '';
    const dayHeaders = ['일', '월', '화', '수', '목', '금', '토'];
    dayHeaders.forEach(d => {
      const h = document.createElement('div');
      h.className = 'day-header';
      h.textContent = d;
      grid.appendChild(h);
    });

    const firstDay = new Date(viewYear, viewMonth - 1, 1).getDay();
    const daysInMonth = new Date(viewYear, viewMonth, 0).getDate();
    const prevDays = new Date(viewYear, viewMonth - 1, 0).getDate();
    const today = new Date();
    const todayStr = `${today.getFullYear()}-${pad2(today.getMonth() + 1)}-${pad2(today.getDate())}`;
    const events = sharedData.events || [];
    const color = sharedData.projectColor || '#6b7280';

    // previous month
    for (let i = firstDay - 1; i >= 0; i--) {
      const day = prevDays - i;
      const cell = createCell(day, true, '', color, events);
      grid.appendChild(cell);
    }
    // current month
    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = `${viewYear}-${pad2(viewMonth)}-${pad2(d)}`;
      const isToday = dateStr === todayStr;
      const dayOfWeek = new Date(viewYear, viewMonth - 1, d).getDay();
      const cell = createCell(d, false, dateStr, color, events, isToday, dayOfWeek);
      grid.appendChild(cell);
    }
    // next month
    const totalCells = firstDay + daysInMonth;
    const remaining = (7 - (totalCells % 7)) % 7;
    for (let i = 1; i <= remaining; i++) {
      const cell = createCell(i, true, '', color, events);
      grid.appendChild(cell);
    }
  }

  function createCell(day, isOther, dateStr, color, events, isToday, dayOfWeek) {
    const cell = document.createElement('div');
    cell.className = 'day-cell';
    if (isOther) cell.classList.add('other-month');
    if (isToday) cell.classList.add('today');
    if (dayOfWeek === 0) cell.classList.add('sunday');
    if (dayOfWeek === 6) cell.classList.add('saturday');

    const num = document.createElement('div');
    num.className = 'day-num';
    num.textContent = day;
    cell.appendChild(num);

    if (dateStr) {
      const dayEvents = events.filter(ev => ev.date === dateStr);
      dayEvents.slice(0, 3).forEach(ev => {
        const chip = document.createElement('div');
        chip.className = 'event-chip';
        chip.style.background = color;
        chip.textContent = ev.title || '';
        cell.appendChild(chip);
      });
      if (dayEvents.length > 3) {
        const more = document.createElement('div');
        more.className = 'event-chip';
        more.style.background = 'transparent';
        more.style.color = '#94a3b8';
        more.style.fontSize = '9px';
        more.textContent = `+${dayEvents.length - 3}`;
        cell.appendChild(more);
      }
      cell.style.cursor = 'pointer';
      cell.onclick = () => showEventList(dateStr);
    }
    return cell;
  }

  function showEventList(dateStr) {
    const events = (sharedData.events || []).filter(ev => ev.date === dateStr);
    const section = document.getElementById('eventListSection');
    const list = document.getElementById('eventList');
    const title = document.getElementById('eventListTitle');

    if (events.length === 0) { section.style.display = 'none'; return; }

    const [y, m, d] = dateStr.split('-');
    title.textContent = `${y}. ${m}. ${d} (${['일','월','화','수','목','금','토'][new Date(+y, +m-1, +d).getDay()]})`;
    list.innerHTML = '';
    const color = sharedData.projectColor || '#6b7280';

    events.sort((a, b) => (a.time || '').localeCompare(b.time || '')).forEach(ev => {
      const item = document.createElement('div');
      item.className = 'event-item' + (ev.isCompleted ? ' completed' : '');
      const dot = document.createElement('div');
      dot.className = 'ev-dot';
      dot.style.background = color;
      const info = document.createElement('div');
      info.className = 'ev-info';
      const t = document.createElement('div');
      t.className = 'ev-title';
      t.textContent = ev.title || '(제목 없음)';
      info.appendChild(t);
      if (ev.time) {
        const time = document.createElement('div');
        time.className = 'ev-time';
        time.textContent = ev.time;
        info.appendChild(time);
      }
      if (ev.memo) {
        const memo = document.createElement('div');
        memo.className = 'ev-memo';
        memo.textContent = ev.memo;
        info.appendChild(memo);
      }
      item.appendChild(dot);
      item.appendChild(info);
      list.appendChild(item);
    });

    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth' });
  }

  loadSharedProject();
</script>
</body>
</html>
